
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en-US" xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml">
	<head>

	<title>Curl Me  Up</title>

	<link rel="stylesheet" type="text/css" href="style.css" />
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
	<script type="text/javascript" src="definition.json"></script>
	<script type="text/javascript">
	
		currentElementName = "";
		currentElementMethods = "";
		currentMethodName = "";

		$(document).ready(function(){
			//Get the callback functions
			$.each(functions, function(key, val) {
				
				// $.each(val, function(i,k) {
				// 	console.log(key + "." + i);
				// });
				$('#functions').append('<li><a class="functions" href="#" alt="' + key + '">' + key + '</a></li>');
			});
		});
		
		$('a.functions').live("click", function() {
			
			currentElementName = $(this).attr("alt");
			
			//Get the selected element
			$.each(functions, function(key, val) {
				
				if (currentElementName == key) {
					currentElementMethods = val;
				}
			});
			

			$('#methods').html("");			

			//List all the methods for this element
			$.each(currentElementMethods, function(key, val) {
				$('#methods').append('<li><a class="methods" href="#" alt="' + key + '">' + key + '</a></li>');			
			});			
			
			return false;
		});
		
		$('a.methods').live("click", function() {
			currentMethodName = $(this).attr("alt");
			
			$.each(currentElementMethods, function(key, val) {
				//Extract the fields
				if (currentMethodName == key) {
					$('#fields').html(exploreFields(val));
				}
			});
			
			createCurlCommand();

			return false;
		});
		
		$('input').live("change", function() {
			createCurlCommand();
		});
		
		function exploreFields(root) {
			var fields = "";
			
			$.each(root, function(key, val) {
				if (val._text == undefined) {
					fields += '<div class="fields" alt="' + key + '">';
					fields += '<h3>' + key + '</h3>';
					fields += exploreFields(val);
					fields +='</div>';
				} else {
					fields += '<label>' + key + '</label>';
					fields += '<input class="fields" type="text" alt="' + key + '"></input><br/>';
				}
			});
			
			return fields;
		}
		
		function createCurlCommand() {
			var command = "curl -u ";
			command += $('#Token').val();
			command += ":X ";
			command += $('#URL').val();
			command += " -d '";
			
			command += '<request method="' + currentElementName + '.' + currentMethodName + '">';
			command += parseCurlFields('#fields');
			command += '</request>';
			command += "'";
			
			$('#curl_result').val(command);
			
		}
		
		function parseCurlFields(parent) {
			var xml = ""
			
			var numInputs = 0;
			var numDivFields = 0;
			var tempParseResult = ""
			
			numInputs = $(parent + ' > input').size();
			numDivFields = $(parent + ' > div').size();
			
			
			if(numInputs == 0) {
				$.each($(parent + ' > div'), function() {
					tempParseResult = parseCurlFields(parent + '> div');
					
					if (tempParseResult != "") {
						xml += '<' + $(this).attr("alt") + '>';
						xml += tempParseResult;
						xml += '</' + $(this).attr("alt") + '>';
					}
				});				
			} else {
				$.each($(parent + ' > input'), function() {
					if ($(this).val() != "") {
						xml += '<' + $(this).attr("alt") + '>';
						xml += $(this).val();
						xml += '</' + $(this).attr("alt") + '>';
					}
				});
				
				if (numDivFields > 0) {
					$.each($(parent + ' > div'), function() {
						tempParseResult = parseCurlFields(parent + '> div');

						if (tempParseResult != "") {
							xml += '<' + $(this).attr("alt") + '>';
							xml += tempParseResult;
							xml += '</' + $(this).attr("alt") + '>';
						}
					});	
				}
			}
			
			return xml;
		}
	
	</script>

	</head>
	<body>
		<h1>Curl Me Up</h1>

		<label for="">API URL</label>
		<input id="URL" type="text" size="40"/>
		<label for="">Authentication Token</label>
		<input id="Token" type="text" size="40"/>
		
		<h2>API Calls</h2>
		<ul id="functions"></ul>
		
		<h2>Methods</h2>
		<ul id="methods"></ul>
		
		<h2>Fields</h2>
		<div id="fields" class="fields">
		</div>
		
		<h2>Curl Command</h2>
		<textarea id="curl_result" rows="10" cols="50"></textarea>
	</body>
</html>